# Шаблон приложения FastAPI с аутентификацией и авторизацией

Этот проект представляет собой готовый шаблон для разработки масштабируемых веб-приложений на основе **FastAPI** с
полноценной системой аутентификации и авторизации. Проект включает модульную архитектуру, поддерживает гибкое
логирование с **loguru**, и взаимодействие с базой данных через **SQLAlchemy** с асинхронной поддержкой. Система
миграций **Alembic** упрощает работу со схемой базы данных.

## Стек технологий

- **Веб-фреймворк**: FastAPI
- **ORM**: SQLAlchemy с асинхронной поддержкой через aiosqlite
- **База данных**: PostgreSQL (легко заменяемая на другую SQL-СУБД)
- **Система миграций**: Alembic
- **Авторизация/Аутентификация**: bcrypt для хеширования паролей, python-jose для защиты данных с использованием JWT

## Зависимости проекта

- `fastapi[all]==0.115.0` - высокопроизводительный веб-фреймворк
- `pydantic==2.9.2` - валидация данных
- `uvicorn==0.31.0` - ASGI-сервер
- `jinja2==3.1.4` - шаблонизатор
- `SQLAlchemy==2.0.35` - ORM для работы с базами данных
- `aiosqlite==0.20.0` - асинхронная поддержка SQLite
- `alembic==1.13.3` - управление миграциями базы данных
- `bcrypt==4.0.1` и `passlib[bcrypt]==1.7.4` - хеширование паролей
- `python-jose==3.3.0` - работа с JWT токенами
- `loguru==0.7.2` - красивое и удобное логирование
- `asyncpg==0.30.0` - позволяет выполнять асинхронные запросы к PostgreSQL

## Структура проекта

Проект построен с учётом модульной архитектуры, что позволяет легко расширять приложение и упрощает его поддержку.
Каждый модуль отвечает за отдельные задачи, такие как авторизация или управление данными.

### Основная структура проекта

```
├── app/                            # Основное приложение
│   ├── auth/                       # Модуль аутентификации
│   │   ├── __init__.py             # Инициализация модуля
│   │   ├── dao.py                  # Data Access Object для работы с БД (аутентификация)
│   │   ├── models.py               # Модели Pydantic/SQLAlchemy для аутентификации
│   │   ├── router.py               # API роуты FastAPI
│   │   ├── schemas.py              # Схемы Pydantic
│   │   └── utils.py                # Вспомогательные функции (JWT, хеширование и т.д.)
│   ├── core/                       # Ядро приложения
│   │   ├── dependencies/           # Зависимости в проекте
│   │   │   ├── __init__.py         
│   │   │   ├── auth_dep.py         # Зависимости для аутентификации
│   │   │   └── dao_dep.py          # Зависимости для DAO
│   │   ├── exceptions/             # Кастомные исключения
│   │   │   ├── __init__.py         
│   │   │   └── user_exceptions.py  # Исключения пользовательского модуля
│   │   ├── __init__.py             
│   │   ├── config.py               # Конфигурация приложения
│   │   └── constants.py            # Константы
│   ├── dao/                        # Общие DAO для приложения
│   │   ├── __init__.py
│   │   ├── base.py                 # Базовый DAO класс
│   │   └── database.py             # Настройки подключения к БД
│   ├── migration/                  # Миграции базы данных
│   │   ├── versions/               # Файлы миграций
│   │   ├── env.py                  # Настройки среды для Alembic
│   │   ├── README                  # Документация по миграциям
│   │   └── script.py.mako          # Шаблон для генерации миграций
│   ├── static/                     # Статические файлы приложения
│   │   └── __init__.py
│   ├── main.py                     # Основной файл для запуска приложения
├── .env                            # Конфигурация окружения
├── alembic.ini                     # Конфигурация Alembic
├── README.md                       # Документация проекта
└── requirements.txt                # Зависимости проекта
```

Обновленный раздел с подробным описанием основных модулей:

---

### Основные модули

#### **app/auth** - Модуль для аутентификации и авторизации

Модуль отвечает за управление процессами аутентификации (входа пользователей) и авторизации (проверки доступа).  
Основные файлы:

- **`dao.py`**: Объект доступа к данным пользователей. Содержит методы для работы с базой данных (создание, обновление,
  поиск пользователей и т. д.).
- **`dependencies.py`**: Внедрение зависимостей, таких как проверка токенов и авторизация для защищённых маршрутов.
- **`models.py`**: Определяет ORM-модели данных для пользователей (например, таблица Users в базе данных).
- **`router.py`**: Роутер для маршрутизации запросов, связанных с аутентификацией. Определяет эндпоинты для входа,
  регистрации и проверки доступа.
- **`schemas.py`**: Определяет Pydantic-схемы для валидации входных данных и структуры ответов (например, формат данных
  для регистрации пользователей).
- **`utils.py`**: Вспомогательные функции для работы с токенами (создание, проверка JWT) и шифрование паролей.

---

#### **app/dao** - Базовый слой доступа к данным (Data Access Layer)

Модуль содержит абстракции для работы с базой данных. Используется для управления подключениями и реализации
CRUD-операций.

- **`base.py`**: Базовый класс DAO, предоставляющий общие методы для работы с базой данных, такие как добавление,
  обновление, удаление и поиск записей.
- **`database.py`**: Отвечает за подключение к базе данных, управление сессиями SQLAlchemy, а также создание
  асинхронного подключения (например, через `aiosqlite`).

---

#### **app/migration** - Управление миграциями базы данных с Alembic

Модуль упрощает управление схемой базы данных и позволяет безопасно вносить изменения.

- **`versions/`**: Хранятся файлы миграций, автоматически создаваемые Alembic.
- **`env.py`**: Основной файл конфигурации для Alembic. Определяет подключение к базе данных и взаимодействие с ORM.
- **`script.py.mako`**: Шаблон для генерации новых файлов миграций.

---

#### **app/core/dependencies** - Управление зависимостями в проекте

Модуль содержит зависимости, которые используются в проекте.

- **`auth_dep.py`**: Зависимости, связанные с авторизацией пользователя в системе
- **`dao_dep.py`**: Зависимости, связанные с управллением сессией SQLAlchemy и с работой с дочерними классами BaseDao

---

#### **app/core/config.py** - Настройки и конфигурация приложения

- Определяет параметры приложения, загружаемые из файла `.env`. Например:
    - `SECRET_KEY`: Секретный ключ для подписания JWT.
    - `ALGORITHM`: Алгоритм хеширования токенов.
    - `DB_HOST`: Хост сервера PostgreSQL.
    - `DB_PORT`: Порт PostgreSQL сервера.
    - `DB_NAME`: Имя базы данных, к которой нужно подключиться.
    - `DB_USER`: Имя пользователя PostgreSQL с правами на чтение/запись в указанную БД. 
    - `DB_PASSWORD`: Пароль пользователя БД.
- Обеспечивает удобное управление конфигурацией для разных окружений (локальное, тестовое, продакшн).

---

#### **main.py** - Основной файл для запуска приложения

- **Инициализация приложения**: Настраивает FastAPI-приложение, включая параметры, такие как название, версия, и
  описание.
- **Подключение роутеров**: Регистрирует маршруты, определённые в модулях приложения, например:
    - `app.auth.router` для маршрутов авторизации.
    - Любые дополнительные модули (например, `app.users.router`).
- **Настройка зависимостей**: Внедряет глобальные зависимости, такие как подключение к базе данных или параметры
  конфигурации.
- **Настройка middleware**: Добавляет промежуточные слои для обработки запросов (например, CORS, сжатие, обработка
  ошибок).
- **Обработка ошибок**: Определяет глобальные обработчики исключений, чтобы возвращать понятные ответы при возникновении
  ошибок (например, 401 Unauthorized или 500 Internal Server Error).
- **Запуск сервера**: Используется для старта приложения с помощью ASGI-сервера (Uvicorn).

## Настройка аутентификации и авторизации

Для аутентификации используется JSON Web Token (JWT) с bcrypt для хеширования паролей и python-jose для генерации и
проверки токенов. Это обеспечивает безопасное хранение данных и защищает API-эндпоинты.

## Запуск приложения

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/Yakvenalex/FastApiWithAuthSample.git .
   ```

2. Установите зависимости:

   ```bash
   pip install -r requirements.txt
   ```

3. Создайте и настройте `.env` файл:

   ```env
   SECRET_KEY=supersecretkey
   ALGORITHM=HS256
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=Название БД
   DB_USER=Имя пользователя
   DB_PASSWORD=Пароль
   ```

4. Запустите приложение с Uvicorn:

   ```bash
   uvicorn app.main:app --reload --port 8005
   ```

При необходимости замените port на нужный.

## Миграции базы данных

1. Инициализируйте Alembic:

   ```bash
   cd app
   alembic init -t async migration
   ```

   Затем переместите `alembic.ini` в корень проекта.

2. В `alembic.ini` установите `script_location` как `app/migration`.

3. Создайте миграцию:

   ```bash
   alembic revision --autogenerate -m "Initial migration"
   ```

4. Примените миграции:

   ```bash
   alembic upgrade head
   ```

## Лучшие практики

- Разделяйте функциональность приложения на модули для удобства тестирования и поддержки.
- Обрабатывайте ошибки с четкими ответами и HTTP-кодами.
- Проводите миграции с Alembic для управления схемой базы данных.
- Используйте переменные окружения для безопасного хранения конфиденциальных данных.

---

Этот шаблон является мощной и удобной основой для разработки приложений на FastAPI с поддержкой аутентификации,
авторизации и структурированной архитектуры, готовой к масштабированию.